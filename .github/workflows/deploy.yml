name: Python Package CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Formatting with black
      run: black . --check .
      continue-on-error: true
      id: black

    - name: Lint with flake8
      run: flake8 .
      continue-on-error: true
      id: flake8

    - name: Test with pytest
      run: pytest --cov=./ --cov-report=xml
      continue-on-error: true
      id: pytest

    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage.xml
        if-no-files-found: error

    - name: Determine job status
      id: job_status
      run: |
        if [[ "${{ steps.black.outcome }}" == "failure" || "${{ steps.flake8.outcome }}" == "failure" || "${{ steps.pytest.outcome }}" == "failure" ]]; then
          echo "status=failure" >> $GITHUB_OUTPUT
        else
          echo "status=success" >> $GITHUB_OUTPUT
        fi

    - name: Slack Notification
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ steps.job_status.outputs.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        author_name: GitHub Actions
        mention: here
        if_mention: failure,cancelled
        job_name: ${{ job.job }}
        channel: github-ci-notifications
        icon_emoji: ':github:'
        username: GitHub Actions
        text: |
          *Repository:* ${{ github.repository }}
          *Branch:* ${{ github.ref }}
          *Commit:* ${{ github.sha }}
          *Author:* ${{ github.actor }}
          
          *Job Status:* ${{ steps.job_status.outputs.status }}
          
          *Details:*
          - Formatting (Black): ${{ steps.black.outcome }}
          - Linting (Flake8): ${{ steps.flake8.outcome }}
          - Tests (Pytest): ${{ steps.pytest.outcome }}
          
          ${{ steps.job_status.outputs.status == 'success' && ':white_check_mark: All checks passed successfully!' || ':x: Some checks failed. Please review the workflow for more details.' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}